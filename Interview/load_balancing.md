# 로드 밸런싱 (Load Balancing)

## 1. 개요
로드 밸런싱은 애플리케이션을 지원하는 리소스 풀(서버, 컨테이너, 인스턴스 등)로 들어오는 네트워크 트래픽(요청)을 균등하고 효율적으로 분산하는 기술입니다. 로드 밸런서는 일반적으로 애플리케이션 서버 앞단(클라이언트와 서버 사이)에 위치한 리버스 프록시로서, 클라이언트 요청을 어떤 서버에 전달할지 결정하고 트래픽을 제어합니다.

이를 통해 다음을 달성합니다.
- 가용성: 서버 일부 장애 시에도 트래픽을 정상 서버로 우회하여 서비스 지속
- 확장성: 수평 확장(Scale-out)으로 처리량 증가
- 성능: 혼잡 완화, Keep-Alive 재사용, 연결 풀 등으로 지연 감소
- 보안: TLS 종료(TLS termination), WAF 연계, IP 제한 등 보안 제어 지점 확보

간단한 구조:

```
[Client] ──▶ (Load Balancer) ──▶ [App A]
                                 [App B]
                                 [App C]
```

## 2. 왜 필요한가
- 단일 장애 지점(SPOF) 제거 및 장애 격리
- 무중단 배포(Blue-Green, Canary) 지원 — 가중치로 릴리즈 트래픽 제어
- 장/단기 트래픽 변동 대응(오토스케일링과 연동)
- 세션 관리 전략(스티키 세션/외부 세션 저장소) 선택지 제공

## 3. 동작 레이어 및 공통 기능
- L4 (전송 계층, TCP/UDP): IP/포트 기반 라우팅, 고성능/저오버헤드. 컨텐츠 기반 분기는 어려움.
- L7 (애플리케이션 계층, HTTP/HTTPS/gRPC): URL/헤더/쿠키/메소드 등 컨텐츠 기반 라우팅 가능, 가시성↑.
- 헬스 체크(Health Check): HTTP, TCP, gRPC, 커스텀 스크립트 등으로 노드 상태 모니터링.
- 세션 지속성(Sticky Session/Affinity): 쿠키/헤더/IP 기반으로 같은 클라이언트를 동일 서버에 라우팅.
- TLS 종료/패스스루: LB에서 TLS 종료하여 서버 부담 감소 또는 종단 간 암호화 유지.
- 슬로우 스타트/워밍업: 새로 합류한 서버에 점진적으로 트래픽 할당.

## 4. 로드 밸런싱 알고리즘
아래는 대표적인 방식과 각각의 특성입니다.

### 4.1 라운드 로빈 (Round Robin)
- 설명: 요청을 순환 순서대로 분배합니다. 서버가 A, B, C라면 요청은 ABCABC…
- 장점: 구현이 단순, 평균적으로 고른 분산.
- 단점: 서버의 현재 부하/응답 시간/능력 차이를 반영하지 않음.
- 적합: 동등한 성능의 서버, 비교적 균질한 요청 패턴.

### 4.2 가중치 라운드 로빈 (Weighted Round Robin)
- 설명: 각 서버에 처리 능력/가용 자원에 비례한 가중치를 부여하여 라운드 로빈 분배 비율을 조정.
- 장점: 이기종 서버 환경에서 더 현실적인 분배 가능.
- 단점: 여전히 실시간 상태(부하/지연)는 반영하지 못할 수 있음.
- 적합: 서버 성능 편차가 존재하나 상태 기반 측정이 어려운 환경.

### 4.3 최소 연결 (Least Connections)
- 설명: 현재 활성 연결 수가 가장 적은 서버로 라우팅.
- 장점: 장기 연결(웹소켓, HTTP/2 다중화, 업로드 등)이 많은 환경에서 유리.
- 단점: 서버 처리 능력 차이를 모르면 강한 서버에 더 많은 연결이 몰려 비공평할 수 있음.
- 적합: 서버 성능이 유사하고, 동시 연결 편차를 평준화하고 싶은 경우.

### 4.4 가중치 최소 연결 (Weighted Least Connections)
- 설명: 최소 연결 방식에 가중치를 더해, 성능이 높은 서버가 더 많은 연결을 감당하도록 조정.
- 장점: 이기종 + 장기 연결 환경에 적합.
- 단점: 정확한 가중치 산정이 필요, 동적 변화에는 둔감할 수 있음.

### 4.5 최소 응답 시간 (Least Response Time)
- 설명: 각 서버의 평균 응답 시간(RTT/TTFB 등)을 모니터링하여 가장 빠른 서버로 라우팅.
- 장점: 사용자 체감 속도 개선에 직접적.
- 단점: 지표의 노이즈/스파이크에 민감, 지연만 보고 연결 수/CPU 사용률 등은 간과할 수 있음.
- 적합: 응답 시간 변동성이 큰 서비스, 지연 최적화가 최우선인 경우.

### 4.6 IP 해시 (IP Hash)
- 설명: 클라이언트의 IP를 해시하여 특정 서버에 매핑. 동일 클라이언트는 동일 서버로 라우팅(친화성 유지).
- 장점: 상태 정보를 서버 로컬에 둔 경우 세션 일관성 유지에 쉬움.
- 단점: 트래픽 분포 불균형 가능(특정 대역/프록시로 쏠림), 스케일 변경 시 리맵 폭이 큼.
- 적합: 간단한 스티키 세션이 필요하지만 별도 세션 저장소가 없는 경우.
- 팁: 일관 해싱(Consistent Hashing)을 쓰면 스케일 변경 시 재배치 폭을 줄일 수 있음.

### 4.7 랜덤(두 번의 선택) — Power of Two Choices
- 설명: 임의로 두 서버를 뽑아 더 가벼운 쪽으로 보내는 방식. 간단하지만 상한 부하를 크게 낮춤.
- 장점: 구현 간단, 관측 지표 최소화로도 높은 효율.
- 단점: 엄밀한 최적은 아니며, 지표 신뢰도가 낮으면 오판 가능.

## 5. 선택 가이드
- 서버가 동질적이고 요청도 균질: Round Robin 또는 Weighted RR(가벼운 가중치)
- 서버 성능이 이질적: Weighted RR 또는 Weighted Least Connections
- 장기 연결/동시 연결 편차가 문제: Least Connections(필요 시 가중치)
- 지연이 가장 중요: Least Response Time(지표 안정화를 위한 EWMA 등 적용 고려)
- 세션 친화성이 필요: IP Hash 또는 Cookie 기반 Sticky Session(권장: 외부 세션 저장소)

## 6. 운영/설계 고려사항
- 헬스 체크: 주기, 타임아웃, 연속 실패/성공 임계치, 앱 레벨 엔드포인트 준비
- 워밍업/슬로우 스타트: 새 인스턴스가 캐시/컴파일/콜드 스타트 비용을 흡수하도록 점진 가중치
- 무중단 배포: Blue-Green/Canary — 가중치 기반 단계적 전환, 롤백 플랜
- 아웃라이어 검출/서킷 브레이커: 지연 급증/오류율 상승 서버 일시 격리
- 오토스케일링: 스케일 이벤트와 라우팅 정책의 상호작용(리맵 폭, 콜드 스타트)
- 보안/네트워킹: TLS 정책, HTTP/2/3, 헤더 보안, 소스 IP 보존(X-Forwarded-For)
- 상태 관리: 가능하면 세션 외부화(예: Redis). 스티키 세션은 확장/장애 복구 시 제약이 생김

## 7. 간단한 다이어그램

스티키 세션(쿠키 기반) 예시:
```
[Client] ──▶ (LB: cookie=SID) ──▶ [App A]  ← 동일 쿠키면 계속 A로
             └──────────────────▶ [App B]
```

Blue-Green 배포(가중치 라우팅) 예시:
```
          90%                     10%
[Client] ──▶ (LB) ───────────▶ [v1 Blue]
              │
              └──────────────▶ [v2 Green]
```

