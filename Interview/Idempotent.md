# 멱등성이란?

**컴퓨터 과학에서 `멱등성(Idempotency)`이란, 연산을 여러 번 수행해도 결과가 변하지 않는 속성을 의미합니다.**  
즉, 같은 작업을 한 번 수행하든 여러 번 수행하든 결과가 동일하면 해당 작업은 멱등합니다.

## 예제
- 수학에서 `f(x) = x` 함수는 멱등합니다. (예: `f(f(x)) = f(x)`)
- 데이터베이스에서 `UPDATE users SET age = 30 WHERE id = 1;` 쿼리는 여러 번 실행해도 동일한 결과를 반환하므로 멱등합니다.
- 파일 시스템에서 `chmod 644 file.txt` 명령어는 여러 번 실행해도 동일한 권한이 유지되므로 멱등합니다.

---

## HTTP 메서드와 멱등성

### 멱등한 메서드
다음 HTTP 메서드는 여러 번 호출해도 서버의 상태가 변하지 않거나, 결과가 동일합니다.
- `GET` : 리소스를 조회하는 요청으로 여러 번 호출해도 데이터 변경이 없습니다.
- `PUT` : 특정 리소스를 대체하는 요청이므로 같은 요청을 반복해도 결과가 동일합니다.
- `DELETE` : 같은 리소스를 여러 번 삭제 요청해도 결국 리소스는 삭제된 상태가 유지됩니다.

### 멱등하지 않은 메서드
다음 HTTP 메서드는 호출할 때마다 서버의 상태가 바뀌거나 다른 응답이 반환될 수 있습니다.
- `POST` : 새 리소스를 생성하는 요청으로, 여러 번 호출하면 중복된 데이터가 생성될 수 있습니다.
- `PATCH` : 리소스의 일부를 수정하는 요청으로, 상태가 다르게 변화할 가능성이 있습니다.

---

## 멱등성과 안전성의 차이

- **안전성(Safety)** : 리소스를 변경하지 않는 메서드의 속성입니다. `GET`, `HEAD`, `OPTIONS` 메서드는 안전한 메서드입니다.
- **멱등성(Idempotency)** : 여러 번 수행해도 결과가 동일한 메서드의 속성입니다. `PUT`, `DELETE` 메서드는 멱등하지만, 리소스를 변경하므로 안전한 메서드는 아닙니다.

> **[RFC 7231](https://www.rfc-editor.org/rfc/rfc7231#section-4.2.2)**에서는 HTTP 메서드의 안전성과 멱등성에 대해 정의하고 있습니다.

---

## API에서의 멱등성 구현

API에서 멱등성을 보장하려면 **멱등성 키(Idempotency Key)**를 활용할 수 있습니다. 클라이언트가 요청 시 고유한 멱등성 키를 서버에 전달하면, 서버는 이 키를 기반으로 동일한 요청인지 확인하고 중복 처리를 방지합니다.

### 구현 방법
1. **클라이언트 측**: 요청을 보낼 때마다 고유한 멱등성 키를 생성하여 헤더에 포함시킵니다.
   ```http
   Idempotency-Key: {고유한_키}
   ```
2. **서버 측**: 수신한 멱등성 키를 저장하고, 동일한 키로 들어온 요청이 이미 처리되었는지 확인합니다. 처리된 요청이라면 저장된 응답을 반환하고, 그렇지 않다면 요청을 처리한 후 응답을 저장합니다.

> **[IETF 초안](https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header)**에서는 멱등성 키 헤더에 대한 표준을 제안하고 있습니다.

---

## 멱등성이 필요한 이유
- **안전성(Safety)** : 네트워크 장애나 중복 요청이 발생해도 동일한 결과를 보장합니다.
- **재시도 가능(Retryability)** : 클라이언트에서 동일한 요청을 다시 보내더라도 부작용 없이 처리할 수 있습니다.
- **캐싱(Cacheability)** : 멱등한 요청은 캐싱하기 쉬우며, 서버 부하를 줄일 수 있습니다.

---

## 멱등성 보장 기법
멱등하지 않은 요청도 적절한 방법을 사용하면 멱등성을 보장할 수 있습니다.
1. **클라이언트에서 `unique key` 사용**
    - 예: `POST` 요청 시 클라이언트가 `UUID`를 생성하여 서버에 중복 요청 방지
2. **서버에서 중복 요청 감지**
    - 예: 요청을 기록하여 동일한 요청이 다시 오면 무시
3. **트랜잭션을 사용하여 중복 처리 방지**
    - 예: 데이터베이스의 `UPSERT` 기능 활용

---

## 결론
멱등성은 여러 번 실행해도 동일한 결과를 보장하는 중요한 개념입니다.  
특히 **HTTP API 설계, 데이터베이스 쿼리, 분산 시스템, 네트워크 프로토콜**에서 안정성과 재시도 가능성을 높이기 위해 필수적으로 고려해야 합니다.

> **참고 자료**: [멱등성이 뭔가요? - 토스페이먼츠](https://www.tosspayments.com/blog/articles/dev-1)