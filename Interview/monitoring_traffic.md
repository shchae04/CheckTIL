# TIL: 모니터링으로 트래픽을 제대로 이해하기

- 작성일: 2025-09-02
- 참고: https://toss.tech/article/monitoring-traffic

## 1. 왜 트래픽 모니터링이 어려운가
- 평균값의 함정: 평균 지연시간은 장애를 숨긴다 → p95/p99 등 상위 퍼센타일을 봐야 함.
- 국소 최적화: 개별 인스턴스/엔드포인트만 보면 전체 병목을 놓친다 → 상위-하위 뷰를 함께.
- 과도한 라벨/카디널리티: 너무 세분화하면 저장·쿼리 비용 폭증, 지표도 읽기 어려워짐.

## 2. 무엇을 관찰할 것인가: RED와 USE
- RED(요청 중심)
  - Rate: 초당 요청 수(RPS/QPS)
  - Errors: 오류율(HTTP 5xx/특정 비즈니스 실패율)
  - Duration: 지연시간 p50/p95/p99
- USE(자원 중심)
  - Utilization: 사용률(CPU/메모리/네트워크/디스크/스레드/커넥션)
  - Saturation: 포화도(런큐 길이/큐 대기/GC Stop-the-world/세마포어 대기)
  - Errors: 하드웨어/시스템 에러

## 3. 지표 설계 원칙
- 목적 우선: 장애 탐지용, 용량 계획용, 성능 회귀 감지용 등 "질문"을 먼저 정의.
- 레이블 위생(Label hygiene)
  - 고카디널리티(사용자 ID, 주문 ID, 동적 태그) 지양.
  - 서비스/엔드포인트/인스턴스/지역 정도의 안정적 레이블만 유지.
  - 필요 시 샘플링·집계 파이프라인에서 상세 라벨을 별도 로그/트레이스에 위임.
- 히스토그램/요약 선택
  - 서버 측 퍼센타일이 필요하면 히스토그램(bucket 설계) → p95/p99 산출.
  - 버킷은 SLO 경계, 사용자 체감 임계(예: 100ms/300ms/1s/3s/5s)를 기준으로.
- 집계의 계층화
  - 인스턴스 → 서비스 → 도메인/제품 → 전사 레벨로 rollup 대시보드 구성.

## 4. SLI/SLO와 얼럿
- SLI(측정치) 예시
  - 가용성: 성공률 = 성공 요청수 / 전체 요청수
  - 성능: p99 응답시간
- SLO(목표) 예시
  - 28일 기준 성공률 99.9%, p99 < 300ms
- 에러버짓(Error Budget)
  - 허용 실패량을 남겨두고, 버짓 소진 속도 기반 얼럿(버짓 소모율)으로 노이즈를 줄임.
- 얼럿 설계
  - 사용자 영향 기준(블랙박스 체크, 외부 퍼포먼스) + 내부 영향 기준(RED/USE) 조합.
  - 단발 스파이크 완화: 윈도우링(예: 5m/30m)과 다단계 심각도.

## 5. 추적/로그와의 역할 분담
- 메트릭: 빠른 탐지와 추세, 비용 효율적 집계.
- 트레이스: 지연 경로 파악(서비스 간 원인 분석), tail-latency 원인 규명.
  - Head-based 샘플링: 비용 절감, 대표성은 낮을 수 있음.
  - Tail-based 샘플링: 느린 요청 위주 보존, 장애 분석에 유리.
- 로그: 사건의 맥락과 상세 파라미터, 컴플라이언스.

## 6. 비용/성능을 고려한 운영 팁
- 다운샘플링/보존 정책
  - 10s 해상도(2일), 1m(14일), 5m(90일) 등 계층화.
- 지표 수 절제
  - 라벨 곱 폭발 방지: 라벨 수×값 가짓수를 항상 점검.
  - 불필요한 커스텀 타이머/카운터 제거, 공용 라이브러리로 표준화.
- 대시보드 UX
  - 개요 → 서비스 → 엔드포인트 → 인스턴스 드릴다운 경로 고정.
  - 동일 지표 스케일/단위를 통일하여 비교 용이성 확보.

## 7. 실전 체크리스트
- [ ] 서비스별 RED 3종(Rate/Errors/Duration p95/p99) 대시보드 존재
- [ ] 핵심 의존성(데이터베이스/캐시/외부 API)에 대한 USE 지표 모니터링
- [ ] p99 기반 SLO와 에러버짓 얼럿 구성, 노이즈 없는 임계치 설정
- [ ] 히스토그램 버킷을 사용자 체감 임계에 맞게 재설계
- [ ] 고카디널리티 라벨 제거 또는 트레이스/로그로 이관
- [ ] 트레이스 샘플링 전략(head/tail) 정의 및 느린 요청 캡처
- [ ] 대시보드 드릴다운 경로 정렬 및 공통 템플릿 적용
- [ ] 보존 기간·해상도·스토리지 비용 주기적 점검

## 8. 자주 보는 핵심 그래프
- 요청률(RPS), 성공률/오류율(4xx/5xx), p50/p95/p99 응답시간
- 인프라 자원: CPU/메모리/GC, 런큐/스레드/커넥션 풀 포화도, 네트워크 대역폭
- 큐 길이/대기시간, 재시도율/타임아웃율, 다운스트림 의존성 지연시간

## 9. 배운 점 요약
- 평균이 아닌 분포를 본다(p95/p99).
- 라벨 위생과 집계 계층화로 읽기성과 비용을 동시에 잡는다.
- SLO/에러버짓을 기준으로 얼럿을 단순화한다.
- 메트릭-트레이스-로그를 역할 분담해 빠른 탐지와 정확한 원인 파악을 동시에 달성한다.
