# CSRF (Cross-Site Request Forgery)

CSRF(Cross-Site Request Forgery)는 웹 보안 취약점 중 하나로, 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격입니다.

## CSRF 공격의 개념

CSRF 공격은 사용자가 로그인한 상태에서 공격자가 준비한 악의적인 사이트를 방문할 때 발생합니다. 이 공격은 웹 애플리케이션이 인증된 사용자로부터 온 요청을 신뢰한다는 점을 악용합니다.

### 공격 시나리오

1. 사용자가 은행 웹사이트에 로그인하여 인증 쿠키를 받음
2. 로그아웃하지 않은 상태에서 공격자의 웹사이트를 방문
3. 공격자의 웹사이트에는 은행 웹사이트로 자금 이체 요청을 보내는 코드가 포함됨
4. 사용자의 브라우저는 은행 웹사이트에 대한 인증 쿠키를 자동으로 포함하여 요청을 전송
5. 은행 웹사이트는 이 요청이 정당한 사용자로부터 온 것으로 간주하고 처리

### CSRF 공격의 특징

- 사용자는 공격이 진행되고 있다는 사실을 인지하지 못함
- 브라우저가 자동으로 쿠키를 포함시키는 특성을 이용
- 주로 상태 변경 요청(POST, PUT, DELETE)을 대상으로 함
- 공격자는 응답 내용을 볼 수 없음 (Same-Origin Policy 때문)

## CSRF vs XSS

CSRF와 XSS(Cross-Site Scripting)는 모두 웹 보안 취약점이지만 다음과 같은 차이가 있습니다:

| 구분 | CSRF | XSS |
|------|------|-----|
| 목적 | 사용자의 권한으로 작업 수행 | 사용자 브라우저에서 스크립트 실행 |
| 공격 방식 | 사용자가 인증된 상태에서 요청 위조 | 웹사이트에 악성 스크립트 삽입 |
| 취약점 위치 | 서버 측 요청 검증 부재 | 클라이언트 측 입력 검증 부재 |
| 방어 방법 | CSRF 토큰, SameSite 쿠키 | 입력 검증, 출력 인코딩 |

## CSRF 방어 기법

### 1. CSRF 토큰 사용

서버에서 생성한 랜덤 토큰을 폼에 포함시키고, 요청 시 이 토큰을 검증합니다.

### 2. SameSite 쿠키 속성

쿠키에 SameSite 속성을 설정하여 크로스 사이트 요청에 쿠키가 전송되지 않도록 합니다.

SameSite 속성 값:
- **Strict**: 같은 사이트의 요청에만 쿠키 전송
- **Lax**: 같은 사이트 및 top-level navigation(링크 클릭 등)에만 쿠키 전송
- **None**: 모든 크로스 사이트 요청에 쿠키 전송 (Secure 속성 필요)

### 3. 사용자 상호작용 요구

중요한 작업 수행 시 사용자 확인(비밀번호 재입력, CAPTCHA 등)을 요구합니다.

### 4. Referer 검증

HTTP Referer 헤더를 검사하여 요청이 신뢰할 수 있는 출처에서 왔는지 확인합니다.

### 5. Custom Request Headers

AJAX 요청에 사용자 정의 헤더를 추가하고 서버에서 이를 검증합니다. 브라우저의 Same-Origin Policy는 다른 도메인에서 사용자 정의 헤더를 추가하는 것을 제한합니다.

## 결론

CSRF는 사용자의 인증 정보를 이용하여 공격자가 의도한 작업을 수행하게 하는 심각한 보안 취약점입니다. 이를 방지하기 위해서는 CSRF 토큰, SameSite 쿠키, Referer 검증 등 다양한 방어 기법을 적용해야 합니다. 특히 상태를 변경하는 요청(POST, PUT, DELETE)에 대해서는 반드시 CSRF 방어 기법을 적용해야 합니다.

현대 웹 프레임워크들은 대부분 CSRF 방어 기능을 기본으로 제공하므로, 이를 비활성화하지 않고 적절히 활용하는 것이 중요합니다. 또한, REST API를 설계할 때도 CSRF 공격 가능성을 고려하여 적절한 보안 조치를 취해야 합니다.