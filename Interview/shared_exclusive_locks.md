# 공유 락(Shared Lock)과 배타 락(Exclusive Lock)

데이터베이스 시스템에서 동시성 제어는 여러 트랜잭션이 동시에 데이터에 접근할 때 데이터의 일관성과 무결성을 보장하기 위한 중요한 메커니즘입니다. 이러한 동시성 제어의 핵심 요소 중 하나가 바로 '락(Lock)'입니다. 이 문서에서는 가장 기본적인 두 가지 락 유형인 공유 락(Shared Lock)과 배타 락(Exclusive Lock)에 대해 알아보겠습니다.

## 락(Lock)이란?

락은 데이터베이스에서 여러 트랜잭션이 동시에 같은 데이터에 접근할 때 발생할 수 있는 문제를 방지하기 위한 동시성 제어 메커니즘입니다. 락은 특정 데이터에 대한 접근을 제한하여 데이터의 일관성을 유지합니다.

## 공유 락(Shared Lock, S-Lock)

### 정의
공유 락은 읽기 락(Read Lock)이라고도 불리며, 데이터를 읽을 때 사용됩니다. 여러 트랜잭션이 동시에 같은 데이터에 공유 락을 획득할 수 있습니다.

### 특징
- 여러 트랜잭션이 동시에 같은 데이터에 대해 공유 락을 가질 수 있음
- 데이터 읽기 작업에 사용됨
- 다른 트랜잭션의 공유 락 획득을 허용함
- 배타 락과 충돌함 (배타 락이 설정된 데이터에는 공유 락을 설정할 수 없음)

### 사용 예시
```sql
-- MySQL에서 공유 락 사용 예시
SELECT * FROM employees WHERE id = 1 LOCK IN SHARE MODE;

-- 또는 MySQL 8.0 이상에서는
SELECT * FROM employees WHERE id = 1 FOR SHARE;
```

## 배타 락(Exclusive Lock, X-Lock)

### 정의
배타 락은 쓰기 락(Write Lock)이라고도 불리며, 데이터를 수정할 때 사용됩니다. 한 번에 하나의 트랜잭션만 특정 데이터에 대한 배타 락을 획득할 수 있습니다.

### 특징
- 한 번에 하나의 트랜잭션만 데이터에 대한 배타 락을 가질 수 있음
- 데이터 수정 작업(INSERT, UPDATE, DELETE)에 사용됨
- 다른 트랜잭션의 공유 락 및 배타 락 획득을 모두 차단함
- 데이터 변경 작업의 독점적 접근을 보장함

### 사용 예시
```sql
-- MySQL에서 배타 락 사용 예시
SELECT * FROM employees WHERE id = 1 FOR UPDATE;

-- 또는 명시적인 행 잠금
UPDATE employees SET salary = 5000 WHERE id = 1;
```

## 공유 락과 배타 락의 호환성

| 락 유형 | 공유 락(S) | 배타 락(X) |
|---------|-----------|-----------|
| 공유 락(S) | 호환됨 | 호환되지 않음 |
| 배타 락(X) | 호환되지 않음 | 호환되지 않음 |

- 공유 락 + 공유 락: 여러 트랜잭션이 동시에 같은 데이터를 읽을 수 있음
- 공유 락 + 배타 락: 호환되지 않음 (충돌)
- 배타 락 + 배타 락: 호환되지 않음 (충돌)

## 실제 시나리오 예시

### 시나리오 1: 동시 읽기 작업
두 사용자 A와 B가 동시에 같은 제품 정보를 조회하는 경우:
1. 사용자 A가 제품 정보에 공유 락을 설정하고 읽기 시작
2. 사용자 B도 같은 제품 정보에 공유 락을 설정하고 읽기 시작
3. 두 사용자 모두 문제 없이 동시에 정보를 읽을 수 있음

### 시나리오 2: 읽기와 쓰기 충돌
사용자 A가 제품 정보를 읽는 동안 사용자 B가 같은 제품 정보를 수정하려는 경우:
1. 사용자 A가 제품 정보에 공유 락을 설정하고 읽기 시작
2. 사용자 B가 같은 제품 정보에 배타 락을 설정하려고 시도
3. 사용자 A의 공유 락이 해제될 때까지 사용자 B는 대기해야 함
4. 사용자 A의 작업이 완료되고 공유 락이 해제되면, 사용자 B는 배타 락을 획득하고 수정 작업을 수행할 수 있음

### 시나리오 3: 쓰기와 쓰기 충돌
두 사용자가 동시에 같은 제품 정보를 수정하려는 경우:
1. 사용자 A가 제품 정보에 배타 락을 설정하고 수정 시작
2. 사용자 B가 같은 제품 정보에 배타 락을 설정하려고 시도
3. 사용자 A의 배타 락이 해제될 때까지 사용자 B는 대기해야 함
4. 사용자 A의 작업이 완료되고 배타 락이 해제되면, 사용자 B는 배타 락을 획득하고 수정 작업을 수행할 수 있음

## 락 에스컬레이션(Lock Escalation)

락 에스컬레이션은 많은 수의 작은 락(행 수준 락)이 더 큰 락(테이블 수준 락)으로 변환되는 프로세스입니다. 이는 락 관리의 오버헤드를 줄이기 위해 사용됩니다.

예를 들어, 한 트랜잭션이 테이블의 많은 행에 락을 설정하면, 데이터베이스 시스템은 성능 향상을 위해 개별 행 락을 테이블 전체 락으로 에스컬레이션할 수 있습니다.

## 데드락(Deadlock)과 락

공유 락과 배타 락을 사용할 때 주의해야 할 중요한 문제 중 하나는 데드락입니다. 데드락은 두 개 이상의 트랜잭션이 서로가 보유한 락을 기다리며 무한정 대기하는 상황을 말합니다.

### 데드락 예시
1. 트랜잭션 A가 테이블 X의 행 1에 배타 락을 설정
2. 트랜잭션 B가 테이블 Y의 행 2에 배타 락을 설정
3. 트랜잭션 A가 테이블 Y의 행 2에 접근하려고 시도하지만, 트랜잭션 B가 이미 락을 보유 중이므로 대기
4. 트랜잭션 B가 테이블 X의 행 1에 접근하려고 시도하지만, 트랜잭션 A가 이미 락을 보유 중이므로 대기
5. 두 트랜잭션 모두 서로의 락이 해제되기를 무한정 기다리는 데드락 상태에 빠짐

대부분의 데이터베이스 시스템은 데드락 감지 알고리즘을 통해 이러한 상황을 감지하고, 일반적으로 한 트랜잭션을 희생(롤백)시켜 데드락을 해결합니다.

## 결론

공유 락과 배타 락은 데이터베이스 시스템에서 동시성 제어를 위한 기본적인 메커니즘입니다. 공유 락은 여러 트랜잭션이 동시에 데이터를 읽을 수 있게 하면서도, 배타 락은 한 번에 하나의 트랜잭션만 데이터를 수정할 수 있도록 보장합니다. 이러한 락 메커니즘을 이해하고 적절히 활용하면 데이터베이스의 일관성과 무결성을 유지하면서도 동시성을 최대화할 수 있습니다.