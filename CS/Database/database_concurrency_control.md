# 데이터베이스 동시성 제어 (Database Concurrency Control)

데이터베이스 시스템에서 여러 트랜잭션이 동시에 실행될 때 데이터의 일관성과 무결성을 유지하기 위한 메커니즘입니다. 이 문서에서는 대표적인 동시성 제어 방식인 MVCC(Multi-Version Concurrency Control)와 Lock-Based Concurrency Control에 대해 설명합니다.

## MVCC (Multi-Version Concurrency Control)

MVCC는 데이터의 여러 버전을 유지하여 트랜잭션이 동시에 데이터를 읽고 쓸 수 있도록 하는 방식입니다.

### 주요 특징

1. **데이터 버전 관리**: 
   - 데이터의 각 버전을 유지하여 읽기 작업이 쓰기 작업과 독립적으로 이루어질 수 있습니다.
   - 트랜잭션은 시작 시점의 스냅샷을 기반으로 데이터를 읽어, 다른 트랜잭션의 변경 사항을 보지 못합니다.

2. **잠금 없는 읽기 작업**:
   - 읽기 작업 시 잠금을 사용하지 않아 높은 동시성을 제공합니다.
   - 읽기 작업이 잠금에 의해 지연되지 않아, 읽기 중심의 애플리케이션에서 우수한 성능을 보입니다.

3. **충돌 감소**:
   - 읽기 작업 시 잠금을 사용하지 않으므로, 쓰기 작업과의 충돌이 줄어듭니다.

4. **일관성 유지**:
   - 트랜잭션이 시작된 시점의 데이터 상태를 기반으로 읽기 작업을 수행하여 일관성을 유지합니다.
   - 갭락(Gap Lock)과 넥스트키 락(Next-Key Lock)을 통해 팬텀 리드(Phantom Read)를 방지합니다.

### 장점

- 높은 동시성 제공
- 읽기 작업의 성능 향상
- 읽기-쓰기 충돌 감소

### 단점

- 여러 버전의 데이터를 유지해야 하므로 저장 공간이 더 많이 필요할 수 있음
- 버전 관리에 따른 오버헤드 발생 가능

## Lock-Based Concurrency Control

Lock-Based 방식은 데이터에 접근할 때 잠금(Lock)을 사용하여 동시성을 제어합니다.

### 주요 특징

1. **잠금 기반 접근 제어**:
   - 데이터에 접근할 때 잠금을 걸어 다른 트랜잭션의 접근을 제한합니다.
   - 읽기 작업은 공유 잠금(Shared Lock)을, 쓰기 작업은 배타 잠금(Exclusive Lock)을 사용하여 동시성을 제어합니다.

2. **잠금 수준**:
   - 테이블 수준 잠금(Table-Level Lock): 테이블 전체에 잠금을 설정
   - 페이지 수준 잠금(Page-Level Lock): 데이터베이스 페이지 단위로 잠금을 설정
   - 행 수준 잠금(Row-Level Lock): 개별 행에 대해 잠금을 설정

3. **잠금 유형**:
   - 공유 잠금(Shared Lock): 읽기 작업에 사용, 다른 트랜잭션의 읽기는 허용하지만 쓰기는 차단
   - 배타 잠금(Exclusive Lock): 쓰기 작업에 사용, 다른 트랜잭션의 읽기와 쓰기 모두 차단

### 장점

- 직관적인 동시성 제어 메커니즘
- 데이터 일관성과 무결성을 직접적으로 보장

### 단점

- 많은 트랜잭션이 동일한 데이터에 접근할 경우 성능 저하 발생 가능
- 잘못된 잠금 순서나 설계로 인해 교착 상태(Deadlock)가 발생할 위험

## 실제 데이터베이스 시스템에서의 적용

실제 데이터베이스 시스템, 특히 MySQL의 InnoDB는 MVCC와 Lock-Based 방식의 장점을 결합하여 동시성 제어를 최적화합니다.

### 하이브리드 접근 방식

1. **읽기 트랜잭션**:
   - MVCC를 사용하여 일관된 스냅샷을 기반으로 데이터를 읽음
   - 잠금을 최소화하고 높은 동시성을 유지

2. **쓰기 트랜잭션**:
   - 잠금을 사용하여 데이터의 일관성과 무결성을 유지
   - 동시에 데이터 충돌을 방지

### 트랜잭션 격리 수준과의 관계

데이터베이스 시스템은 다양한 트랜잭션 격리 수준을 제공하며, 이는 동시성 제어 방식과 밀접한 관련이 있습니다:

1. **READ UNCOMMITTED**: 가장 낮은 격리 수준으로, 다른 트랜잭션이 커밋하지 않은 변경사항도 볼 수 있음
2. **READ COMMITTED**: 커밋된 데이터만 읽을 수 있음
3. **REPEATABLE READ**: 트랜잭션 내에서 동일한 쿼리는 항상 동일한 결과를 반환
4. **SERIALIZABLE**: 가장 높은 격리 수준으로, 트랜잭션이 순차적으로 실행되는 것처럼 동작

## 어떤 방식을 선택해야 할까?

동시성 제어 방식의 선택은 애플리케이션의 특성과 요구사항에 따라 달라집니다:

- **읽기 중심 애플리케이션**: MVCC가 더 적합할 수 있음
- **쓰기 중심 애플리케이션**: Lock-Based 방식이 데이터 일관성을 더 잘 보장할 수 있음
- **균형 잡힌 접근**: 대부분의 현대 데이터베이스 시스템은 두 방식을 혼합하여 사용

## 결론

데이터베이스 동시성 제어는 다중 사용자 환경에서 데이터의 일관성과 무결성을 유지하기 위한 핵심 메커니즘입니다. MVCC와 Lock-Based 방식은 각각 고유한 장단점을 가지고 있으며, 실제 데이터베이스 시스템에서는 이 두 방식의 장점을 결합하여 최적의 성능과 데이터 일관성을 제공합니다.