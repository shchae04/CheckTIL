# LLM 대응 전략 TIL

본 문서는 서비스/내부도구에 LLM을 도입·운영할 때 필요한 실무 중심의 “대응 전략”을 압축 정리한다.

---

## 1) 목적과 범위
- 목적: 정합성 있는 답변, 낮은 비용/지연, 안전한 운영을 동시에 달성.
- 범위: 프롬프트/아키텍처/품질관리/보안/비용/운영.

---

## 2) 핵심 원칙 (TL;DR)
- Retrieval-First: 모델을 바꾸기보다 데이터를 잘 꺼내 요약해 주입(RAG/하이브리드 검색).
- 최소 토큰, 최대 정보 밀도: 컨텍스트는 압축·요약·구조화(표/키밸류) 위주.
- Guardrails 필수: 금칙어/PII 마스킹/툴 호출 화이트리스트/출처 표기.
- Eval 없인 운영 아님: 자동화된 회귀평가(Precision/Recall/Faithfulness/Latency/Cost) 파이프라인.
- 캐시와 결정성: 프롬프트 템플릿/시스템 프롬프트 고정, 캐시 키 전략 수립.

---

## 3) 프롬프트/컨텍스트 전략
- 역할 분리: System(역할/톤/제약) · Developer(툴/형식) · User(의도) · Context(근거).
- 금지/제약 명시: “추정 금지, 모르겠으면 ‘모름’으로 답”, “출처와 함께 요약”.
- 출력 스키마 강제: JSON Schema/CSV 헤더/마크다운 표 형식 지정 + 유효성 검사.
- 컨텍스트 구성: 핵심 요약 → 근거 스니펫 K개 → 용어집/단위/정의.
- 토큰 예산: 모델/서비스 지연 목표에 따라 상한 설정(예: 입력 ≤ 4k, 출력 ≤ 512).
- 민감도 등급별 프롬프트: 내부/외부/고객지원 등 채널별 가드 강화.

---

## 4) 아키텍처 패턴
- RAG 기본형: BM25+벡터 하이브리드 → 재랭킹 → 압축 요약 → LLM.
- Tool Use(Function Calling): 계산/조회/액션은 도구로 위임, LLM은 의사결정·요약.
- 계획-실행-검증(PEV): 계획 생성 → 도구 실행 → 근거 검증(규칙/LLM) → 응답.
- 안전 레이어: 입력/출력 필터링(PII/금칙/프롬프트주입), 정책 위반 차단.
- 캐시: 
  - 프롬프트 캐시: (templateId, version, normalizedQuestion, topKKeys) → response
  - 검색 결과 캐시: 질의→문서 ID 리스트, TTL과 권한 키 분리
- 스로틀/큐: 동시성 제어, 사용자/테넌트별 쿼터.

---

## 5) 품질/평가(Eval)
- 오프라인 골든셋: 질문–정답–근거 문서 링크 세트 관리.
- 자동 지표: 
  - 정답형: Exact Match/F1, Retrieval Recall@K, Faithfulness(근거 일치율)
  - 생성형: G-Eval/LLM-as-a-Judge, 내용 일관성/출처 참조율
  - 운영: 응답시간 p95, 비용/요청, 도구 호출 실패율
- 회귀 파이프라인: 프롬프트/모델 버전 바꿀 때마다 자동 재측정.

---

## 6) 보안/안전
- 프롬프트 주입 방어: 시스템/툴 호출 규칙을 모델 외부 로직으로 강제, 컨텍스트 분리.
- PII/비밀: 입력/컨텍스트/출력에서 마스킹·익명화; 로그 영구 저장 금지, 단기 보관.
- 권한/테넌시: 검색 단계에서 필터링(조직/프로젝트/문서 권한), 토큰 스코프 검증.
- 출처 표기: 인용 블록/링크로 근거 노출, 환각 대응 가이드 포함.

---

## 7) 비용/성능 최적화
- 모델 선택: 고빈도는 경량 모델(SMALL), 어려운 케이스는 대형 모델(FALLBACK).
- Distill/Speculative: 경량 모델 초안 + 대형 모델 검증/리라이팅.
- 스트리밍: UI TTFB 개선, 부분 결과 표시.
- 토큰 절감: 압축 요약, 불필요 헤더 제거, 숫자/표는 구조화.
- 배치/프리컴퓨트: 인기 질문/요약 사전 계산, 임베딩 일괄 처리.

---

## 8) 운영/관측
- 로깅: 입력 해시/길이, 컨텍스트 문서 ID, 모델/버전, 비용, 지연, 툴 호출 이벤트.
- 메트릭/알람: 오류율/정책 위반/도구 실패/비용 폭증 감지.
- 히트맵: 검색 TopK 문서, 실패 유형(주입/환각/권한), 개선 백로그 자동화.
- 재현성: 프롬프트 템플릿 버전, 모델/파라미터(seed/temperature) 고정.

---

## 9) 체크리스트
- [ ] 컨텍스트가 “근거와 용어 정의”를 포함하는가?
- [ ] 출력 스키마와 유효성 검증이 있는가?
- [ ] 검색 권한 필터가 강제되는가?
- [ ] Eval 파이프라인과 골든셋이 준비되어 있는가?
- [ ] 비용/지연 목표와 캐시 전략이 정의되었는가?
- [ ] 프롬프트 주입/PII 대응이 적용되었는가?

---

## 10) 인터뷰 포인트
- RAG가 필요한 이유와 하이브리드 검색의 장단점 설명.
- 프롬프트 주입 공격 시나리오와 방어 방법.
- Eval 설계: 어떤 지표로 품질을 판단하고 회귀를 막는가?
- 비용/지연을 낮추는 아키텍처 선택과 트레이드오프.

---

## 11) 관련 문서
- LLM 기반 Query 시스템: ./llm_query_system.md
- 백엔드 3요소 개요: ./backend_core_three_components.md
